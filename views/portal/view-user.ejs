<!doctype html>
<html class="no-js" lang="en">

<head>
    <meta charset="utf-8">
    <meta http-equiv="x-ua-compatible" content="ie=edge">
    <title>Uthabiti Africa | User Details</title>
    <meta name="description" content="">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <!-- Top script start -->
      <%- include('../partials/top_script'); %>
    <!-- / Top script end -->
    <style>
        .profile-card {
        border-radius: 1rem;
        overflow: hidden;
        }

        .profile-card .card-header {
        position: relative;
        }

        .profile-avatar img {
        width: 100px;
        height: 100px;
        object-fit: cover;
        }

        .profile-avatar {
        position: relative;
        }

        .profile-card .card-body {
        background-color: #f9fafb;
        }

        .profile-card .btn {
        border-radius: 8px;
        }

        .profile-card .list-group-item {
        border: none;
        background: transparent;
        padding: 0.75rem 1.25rem;
        }

        .profile-card .list-group-item:not(:last-child) {
        border-bottom: 1px solid #e9ecef;
        }
    </style>
</head>

<body>
    <!-- Side bar -->
     <%- include('../partials/portal_sidebar'); %>
     <!-- / Side bar -->

    <!-- Start Welcome area -->
    <div class="all-content-wrapper">
        <div class="container-fluid">
            <div class="row">
                <div class="col-lg-12 col-md-12 col-sm-12 col-xs-12">
                    <div class="logo-pro">
                        <a href="/portal/dashboard"><img class="main-logo" src="/img/logo/logo.png" height="30px" width="80px" alt="" /></a>
                    </div>
                </div>
            </div>
        </div>
        <div class="header-advance-area">
            <!-- Header top start -->
             <%- include('../partials/header_top'); %>
            <!-- / Header top end -->
            <!-- Mobile Menu start -->
            <%- include('../partials/mobile_menu'); %>
            <!-- Mobile Menu end -->
        </div>
        <div class="section-admin container-fluid res-mg-t-15 mg-t-30" style="margin-top: 60px;">
            <div class="row admin">
                <div class="col-md-12">
                    <div class="row">
                        <div class="col-lg-12 col-md-12 col-sm-12 col-xs-12">
                            <div class="author-area-pro">
                                <div class="container-fluid">
                                    <div class="row">
                                        <div class="col-lg-5 col-md-5 col-sm-5 col-xs-12 text-center">
                                            <div class="hpanel blog-box responsive-mg-b-30">
                                                <div class="panel-heading custom-blog-hd">
                                                    <div class="media clearfix">
                                                        <a class="pull-left">
                                                                <img class="img-circle" src="/img/contact/member.jpg" height="200px;" width="200px;" alt="User Photo">
                                                            </a>
                                                        <div class="media-body blog-std">
                                                            <span class="label 
                                                            <% if (user.status === 'Active') { %> label-success 
                                                            <% } else if (user.status === 'Pending') { %> label-warning text-dark 
                                                            <% } else { %> label-danger 
                                                            <% } %>">
                                                            <%= user.status %>
                                                        </span>
                                                        </div>
                                                    </div>
                                                </div>
                                                <div class="panel-body blog-pra">
                                                    <a href="javascript:;">
                                                        <h4><%= user.fullname %></h4>
                                                    </a>
                                                </div>
                                                <div class="panel-footer">
                                                    <table class="table">
                                                        <tr>
                                                            <td>
                                                                <button class="btn btn-custon-three btn-xs btn-default btn-xs" data-toggle="modal" data-target="#editRoleModal"><i class="fa fa-edit"></i> 
                                                                    Edit Role
                                                                </button>
                                                            </td>
                                                            <% if(user.status === 'Blocked') { %>
                                                            <td>
                                                                <button class="btn btn-custon-three btn-default btn-xs" data-toggle="modal" data-target="#resetModal"><i class="fa fa-lock"></i> Reset Account</button>
                                                            </td>
                                                            <% } %>
                                                            <td>
                                                                 <button class="btn btn-custon-three btn-default btn-xs" data-toggle="modal" data-target="#editStatusModal"><i class="fa fa-edit"></i> Edit Status</button>
                                                            </td>
                                                        </tr>
                                                    </table>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-lg-7 col-md-7 col-sm-7 col-xs-12">
                                            <div class="hpanel">
                                                <div class="panel-body">
                                                    <div class="table-responsive">
                                                        <table class="table table-bordered">
                                                            <thead>
                                                                <tr class="bg-red text-white"><th colspan="2">User Details</th></tr>
                                                            </thead>
                                                            <tbody>
                                                                <tr>
                                                                    <td align="left"><strong>Passport/ID Number:</strong></td>
                                                                    <td align="left"><%= user.idNumber %></td>
                                                                </tr>
                                                                <tr>
                                                                    <td align="left"><strong>Email Address:</strong></td>
                                                                    <td align="left"><%= user.email %></td>
                                                                </tr>
                                                                <tr>
                                                                    <td align="left"><strong>Account Created On:</strong></td>
                                                                    <td align="left"><%= new Date(user.create_at).toLocaleDateString() %></td>
                                                                </tr>
                                                                <tr>
                                                                    <td align="left"><strong>Account Last Update:</strong></td>
                                                                    <td align="left"><%= new Date(user.updated_at).toLocaleDateString() %></td>
                                                                </tr>
                                                                <tr>
                                                                    <td align="left"><strong>User Role:</strong></td>
                                                                    <td align="left"><span class="label label-info"><%= user.role %></span></td>
                                                                </tr>
                                                                <tr>
                                                                    <td align="left"><strong>Last Login:</strong></td>
                                                                    <td align="left"><%= user.last_login ? new Date(user.last_login).toLocaleString() : 'None' %></td>
                                                                </tr>
                                                            </tbody>
                                                        </table>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>

                                        <div class="col-lg-12 col-md-12 col-sm-12 col-xs-12 mg-t-30">
                                            <div class="hpanel">
                                                <div class="panel-body">
                                                   <div class="col-lg-12 col-md-12 col-sm-12 col-xs-12">
                                                        <div class="admin-pro-accordion-wrap responsive-mg-b-30">
                                                            <div class="alert-title">
                                                                <h2>User logs</h2>
                                                                <!-- <p>Every activity recorded after login.</p> -->
                                                            </div>
                                                            <div class="panel-group adminpro-custon-design" id="accordion">
                                                                <div class="panel panel-default">
                                                                    <!-- <div class="panel-headin accordion-head mg-b-30">
                                                                        <h4 class="panel-title">
                                                                            <a data-toggle="collapse" data-parent="#accordion" href="#collapse1">Expand Logs</a>
                                                                        </h4>
                                                                    </div> -->
                                                                    <form method="get" class="mb-3 d-flex align-items-center gap-2">
                                                                        <div class="row">
                                                                            <div class="col-md-4 col-md-4 col-sm-4 col-xs-12 mg-b-15">
                                                                                <div class="btn-group">
                                                                                    <a href="/portal/view-user" class="btn btn-default btn-sm"><i class="fa fa-refresh"></i> Refresh</a>
                                                                                    <a href="?exportType=csv" class="btn btn-default btn-sm"><i class="fa fa-file"></i> Export CSV</a>
                                                                                    <a href="?exportType=excel" class="btn btn-default btn-sm"><i class="fa fa-file-excel-o"></i> Export Excel</a>
                                                                                </div>
                                                                            </div>
                                                                            <div class="col-md-3 col-md-3 col-sm-3 col-xs-12 mailbox-pagination mg-b-15">
                                                                                <div class="btn-group">
                                                                                    <div class="form-group data-custon-pick data-custom-mg" id="data_5">
                                                                                        <div class="input-daterange input-group" id="datepicker">
                                                                                            <input type="date" class="form-control" name="start" value="<%= startDate %>" />
                                                                                            <span class="input-group-addon">to</span>
                                                                                            <input type="date" class="form-control" name="end" value="<%= endDate %>" />
                                                                                        </div>
                                                                                    </div>
                                                                                </div>
                                                                            </div>
                                                                            <div class="col-md-3 col-md-3 col-sm-3 col-xs-12 mailbox-pagination mg-b-15">
                                                                                <div class="btn-group">
                                                                                    <div class="form-group data-custon-pick data-custom-mg">
                                                                                        <div class="input-daterange input-group">
                                                                                            <input type="text" name="q" placeholder="Search action or description..." value="<%= q || '' %>" class="form-control">
                                                                                        </div>
                                                                                    </div>
                                                                                </div>
                                                                            </div>
                                                                            <div class="col-md-2 col-md-2 col-sm-2 col-xs-12 mailbox-pagination mg-b-15">
                                                                                <div class="btn-group">
                                                                                    <div class="form-group data-custon-pick data-custom-mg">
                                                                                        <button class="btn btn-default btn-sm"><i class="fa fa-filter"></i> Apply Filter</button>
                                                                                    </div>
                                                                                </div>
                                                                            </div>
                                                                        </div>
                                                                    </form>
                                                                    <div id="collapse1" class="panel-collapse panel-ic collapse in">
                                                                        <div class="panel-body admin-panel-content animated bounce">
                                                                            <% if (logs.length > 0) { %>
                                                                            <div class="table-responsive" style="overflow-x: 10px;">
                                                                                <table class="table table-striped table-hover table-mailbox">
                                                                                    <thead class="thead-light">
                                                                                        <tr>
                                                                                        <th>#</th>
                                                                                        <th>Action</th>
                                                                                        <th>Description</th>
                                                                                        <th>Member ID</th>
                                                                                        <th>IP Address</th>
                                                                                        <th>Device</th>
                                                                                        <th>Date</th>
                                                                                        </tr>
                                                                                    </thead>
                                                                                    <tbody>
                                                                                        <% logs.forEach((log, index) => { %>
                                                                                            <tr>
                                                                                                <td><%= (currentPage - 1) * perPage + index + 1 %></td>
                                                                                                <td><strong><%= log.action %></strong></td>
                                                                                                <td><%= log.description %></td>
                                                                                                <td><%= log.member_id || 'â€”' %></td>
                                                                                                <td><%= log.ip_address %></td>
                                                                                                <td class="text-truncate" style="max-width:150px;" title="<%= log.user_agent %>"><%= log.user_agent %></td>
                                                                                                <td><%= new Date(log.created_at).toLocaleString() %></td>
                                                                                            </tr>
                                                                                        <% }) %>
                                                                                    </tbody>
                                                                                </table>    
                                                                            </div>

                                                                            <div class="custom-pagination mt-4">
                                                                                <nav aria-label="Page navigation">
                                                                                    <ul class="pagination justify-content-center">

                                                                                    <% if (currentPage > 1) { %>
                                                                                        <li class="page-item">
                                                                                        <a class="page-link" href="?page=<%= currentPage - 1 %><%= queryString %>">Previous</a>
                                                                                        </li>
                                                                                    <% } %>

                                                                                    <% paginationRange.forEach(p => { %>
                                                                                        <% if (p === '...') { %>
                                                                                        <li class="page-item disabled">
                                                                                            <span class="page-link">...</span>
                                                                                        </li>
                                                                                        <% } else { %>
                                                                                        <li class="page-item <%= p === currentPage ? 'active' : '' %>">
                                                                                            <a class="page-link" href="?page=<%= p %><%= queryString %>"><%= p %></a>
                                                                                        </li>
                                                                                        <% } %>
                                                                                    <% }); %>

                                                                                    <% if (currentPage < totalPages) { %>
                                                                                        <li class="page-item">
                                                                                        <a class="page-link" href="?page=<%= currentPage + 1 %><%= queryString %>">Next</a>
                                                                                        </li>
                                                                                    <% } %>

                                                                                    </ul>
                                                                                </nav>
                                                                            </div>
                                                                            
                                                                            <% } else { %>
                                                                                <div class="alert alert-info mt-3">No activity logs found for this user.</div>
                                                                            <% } %>
                                                                        </div>
                                                                    </div>
                                                                </div>
                                                            </div>
                                                        </div>
                                                    </div> 
                                                </div>
                                            </div>
                                        </div>

                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

<!-- Modals -->
        <!-- Edit User Modal -->
        <div id="editRoleModal" class="modal FullColor-popup-AlertModal fade">
            <div class="modal-dialog">
                <form method="POST" action="/portal/edit-user-role/<%= user.user_id %>">
                    <div class="modal-content">
                        <div class="modal-header header-color-modal bg-color-4">
                            <h4 class="modal-title">Edit User</h4>
                            <div class="modal-close-area modal-close-df">
                                <a class="close" data-dismiss="modal" href="#"><i class="fa fa-close"></i></a>
                            </div>
                        </div>
                        <div class="modal-body">
                            <div class="row">
                                <div class="col-lg-12 col-md-12 col-sm-12 col-xs-12">
                                    <div class="form-group">
                                        <label class="form-label">Change Role</label>
                                        <select name="role" class="form-control" id="editRole" required>
                                            <option value=""> - select -</option>
                                            <option value="Admin">Admin</option>
                                            <option value="Data Clerk">Data Clerk</option>
                                            <option value="Viewer">Viewer</option>
                                            <option value="Champion">Champion</option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
                            <button type="submit" class="btn btn-danger">Update</button>
                        </div>
                    </div>
                </form>
            </div>
        </div>

<!-- Edit Status -->
 <% 
  let modalTitle = '';
  let modalMessage = '';

  switch (user.status) {
    case 'Active':
      modalTitle = 'Suspend User Account?';
      modalMessage = 'This user account is currently Active. Do you want to Suspend it?';
      break;
    case 'Suspended':
      modalTitle = 'Delete Account?';
      modalMessage = 'This user account is currently Suspended. Do you want to delete it?';
      break;
    case 'Pending':
      modalTitle = 'Activate Account?';
      modalMessage = 'This account is not yet Activated. Use should login to activate it.';
      break;
    case 'Deleted':
      modalTitle = 'Account Status?';
      modalMessage = 'This account is permanently deleted. User cannot access it.';
      break;
    case 'Blocked':
      modalTitle = 'Blocked Account?';
      modalMessage = 'This account is blocked. Reset account to retrieve it.';
      break;
  }
%>
<div id="editStatusModal" class="modal modal-adminpro-general FullColor-popup-AlertModal fade" role="dialog">
    <div class="modal-dialog">
        <div class="modal-content modal-vertical-centered">
            <div class="modal-close-area modal-close-df">
                <a class="close" data-dismiss="modal" href="#"><i class="fa fa-close"></i></a>
            </div>
            <form action="/portal/edit-user-status/<%= user.user_id %>" method="POST">
                <div class="modal-body">
                    <span class="adminpro-icon adminpro-warning modal-check-pro information-icon-pro"></span>
                    <h2><%= modalTitle %></h2>
                    <p><p><%= modalMessage %></p></p>
                </div>
                <% if (!['Deleted', 'Blocked', 'Pending'].includes(user.status)) { %>
                <div class="modal-footer">
                    <input type="hidden" name="currentStatus" value="<%= user.status %>">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-danger">Confirm</button>
                </div>
                <% } %>
            </form>
        </div>
    </div>
</div>

<div id="resetModal" class="modal modal-adminpro-general FullColor-popup-AlertModal fade" role="dialog">
    <div class="modal-dialog">
        <div class="modal-content modal-vertical-centered">
            <div class="modal-close-area modal-close-df">
                <a class="close" data-dismiss="modal" href="#"><i class="fa fa-close"></i></a>
            </div>
            <form action="/portal/reset-user-account/<%= user.user_id %>" method="POST">
                <div class="modal-body">
                    <span class="adminpro-icon adminpro-warning modal-check-pro information-icon-pro"></span>
                    <h2>Reset Account?</h2>
                    <p>User account will be reset to default password.</p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-danger">Confirm</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Bottom script start -->
  <%- include('../partials/bottom_script'); %>
<!-- / Bottom script end -->
</body>
</html>
